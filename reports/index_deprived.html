<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8' />
    <title>DSSG Dashboard</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
        }

        h2,
        h3 {
            margin: 10px;
            font-size: 18px;
        }

        h3 {
            font-size: 16px;
        }

        p {
            margin: 10px;
        }

        /* logo 
        .dssg-logo {
            position: absolute;
            bottom: 3px;
            left: 100px;
            z-index: 100;
            width: 80px;
        }

        .unicef-logo {
            position: absolute;
            bottom: 3px;
            left: 200px;
            z-index: 100;
            width: 80px;
        }

        .stc-logo {
            position: absolute;
            bottom: 3px;
            left: 300px;
            z-index: 100;
            width: 90px;
        }

        */

        /**
        * Create a position for the map
        * on the page */
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /**
        * Set rules for how the map overlays
        * (information box and legend) will be displayed
        * on the page. */
        .map-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #fff;
            margin-right: 20px;
            font-family: Arial, sans-serif;
            overflow: auto;
            border-radius: 3px;
        }

        #features {
            top: 0;
            left: 20px;
            height: 200px;
            margin-top: 20px;
            width: 250px;
        }

        #legend {
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 18px;
            height: 90px;
            margin-bottom: 40px;
            width: 100px;
        }

        .legend-key {
            display: inline-block;
            border-radius: 20%;
            width: 10px;
            height: 10px;
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <style>
    </style>

    <!-- Add logos-->
    <!-- </div>
    <a href="https://didl.berkeley.edu/"><img src="src/didl-logo.png" class="didl-logo"></a>
    <a href="https://cega.berkeley.edu/"><img src="src/cega-logo.png" class="cega-logo"></a>
    </div> -->

    <div id='map'></div>
    <div class='map-overlay' id='features'>
        <h2>Information about Hexagon</h2>
        <div id='pd'>
            <p>Hover over a hexagon!</p>
        </div>
    </div>
    <div class='map-overlay' id='legend'></div>

    <script>
        // TO DO:
        // Add correct values for population


        // The value for 'accessToken' begins with 'pk...'
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFyaW5hdmljaW5pIiwiYSI6ImNsNjB5NjFqNDFyd2wzam5xeXc5OTBvOTcifQ.RWeI0C6NiM1q7NMstm8jmw'; //'YOUR_MAPBOX_ACCESS_TOKEN';
        const map = new mapboxgl.Map({
            container: 'map',
            // Replace YOUR_STYLE_URL with your style URL.
            style: 'mapbox://styles/mapbox/light-v10',
            // style: 'mapbox://styles/marinavicini/cl620uqdk000615ld2q47nri5',
            center: [7.5, 8.5],
            zoom: 10,
        });

        // After 2 seconds it zooms out to display all Nigeria
        setTimeout(function () {
            map.flyTo({
                zoom: 5,
                center: [7.5, 8.5]
            })
        }, 2000)


        map.on('load', function () {
            // Set up legend
            // https://docs.mapbox.com/help/tutorials/choropleth-studio-gl-pt-2/
            const layers = [
                '0.00',
                '0.25',
                '0.50',
                '0.75',
                '1.00',
            ];
            const colors = [
                '#FFC300', //FFEDA0',
                '#FF5733', // #FEB24C',
                '#C70039', //#FC4E2A',
                '#900C3F', //BD0026',
                '#581854' // 800026'
            ];

            layers.forEach((layer, i) => {
                const color = colors[i];
                const item = document.createElement('div');
                const key = document.createElement('span');
                key.className = 'legend-key';
                key.style.backgroundColor = color;

                const value = document.createElement('span');
                value.innerHTML = `${layer}`;
                item.appendChild(key);
                item.appendChild(value);
                legend.appendChild(item);
            });

            map.addSource('nga_tileset', {
                type: 'vector',
                url: 'mapbox://marinavicini.nga_fake_v03'
            });

            // height dependent on population
            map.addLayer({
                'id': 'res7-layer',
                'type': 'fill-extrusion',
                'source': 'nga_tileset', //'composite',
                'source-layer': 'nga_fake_layer_1',
                'layout': {
                    'visibility': 'visible'
                },
                'minzoom': 9,
                'paint': {
                    'fill-extrusion-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'deprived'], // THIS SHOULD BE POPULATION 
                        0,
                        colors[0],
                        0.25,
                        colors[1],
                        0.5,
                        colors[2],
                        0.75,
                        colors[3],
                        1,
                        colors[4]
                    ],
                    'fill-extrusion-height': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'], // THIS SHOULD BE POPULATION 
                        0, // min value
                        0, // output corresponding
                        10000, // max value 
                        10000
                    ],
                    'fill-extrusion-opacity': 0.5
                },
            });

            map.addSource('nga_tileset_res5', {
                type: 'vector',
                url: 'mapbox://marinavicini.nga_fake_res5'
            });

            map.addLayer({
                'id': 'res5-layer',
                'type': 'fill-extrusion',
                'source': 'nga_tileset_res5', //'composite',
                'source-layer': 'nga_fake_layer_1',
                'layout': {
                    'visibility': 'visible'
                },
                'maxzoom': 9,
                'paint': {
                    'fill-extrusion-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'deprived'], // THIS SHOULD BE POPULATION 
                        0,
                        colors[0],
                        0.25,
                        colors[1],
                        0.5,
                        colors[2],
                        0.75,
                        colors[3],
                        1,
                        colors[4]
                    ],
                    'fill-extrusion-height': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'], // THIS SHOULD BE POPULATION 
                        0, // min value
                        0, // output corresponding
                        10000, // max value 
                        10000
                    ],
                    'fill-extrusion-opacity': 0.5
                },
            });

            // HOVER
            // Create a popup, but don't add it to the map yet.
            // https://docs.mapbox.com/mapbox-gl-js/example/popup-on-hover/
            const popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });


            // HOVER RESOLUTION 7
            map.on('mousemove', 'res7-layer', (e) => {
                // Change the cursor style as a UI indicator.
                // map.getCanvas().style.cursor = 'pointer';

                // Copy coordinates array.
                const coordinates = e.features[0].geometry.coordinates[0][0].slice();
                const description = e.features[0].properties.deprived;
                // description = '<h3>' + 'Uncertainty' + marker.properties.description + '</a></p><p><a href="' + marker.properties.link + '" target="_blank"><img src="' + marker.properties.picture + '" title="" /></a></p>'

                // Ensure that if the map is zoomed out such that multiple
                // copies of the feature are visible, the popup appears
                // over the copy being pointed to.
                // while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                //     coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                // }

                // Populate the popup and set its coordinates
                // based on the feature found.
                popup.setLngLat(coordinates).setHTML(description).addTo(map);

                // Add Data in the Box upper
                const feat = map.queryRenderedFeatures(e.point, {
                    layers: ['res7-layer']
                });
                document.getElementById('pd').innerHTML = `<p>Population: ${feat[0].properties.population}<br>
                        Sanitation: ${feat[0].properties.sanitation}<br>
                        Water: ${feat[0].properties.water}<br>
                        Housing: ${feat[0].properties.housing}<br>
                        Education: ${feat[0].properties.education}<br> 
                        </p>`;// feat.length

                // ? `<h3>${feat[0].properties.water}</h3><p><strong><em>${feat[0].properties.hex_code}</strong> people per square mile</em></p>`
                // : '<p>Hover over a hexagon!</p>';
            });

            map.on('mouseleave', 'res7-layer', () => {
                map.getCanvas().style.cursor = '';
                popup.remove();
                document.getElementById('pd').innerHTML = '<p>Hover over a hexagon!</p>';
            });


            // HOVER RESOLUTION 5
            map.on('mousemove', 'res5-layer', (e) => {
                // Change the cursor style as a UI indicator.
                // map.getCanvas().style.cursor = 'pointer';

                // Copy coordinates array.
                const coordinates = e.features[0].geometry.coordinates[0][0].slice();
                const description = e.features[0].properties.deprived;

                popup.setLngLat(coordinates).setHTML(description).addTo(map);

                // Box Information
                const feat = map.queryRenderedFeatures(e.point, {
                    layers: ['res5-layer']
                });
                document.getElementById('pd').innerHTML = `<p>Population: ${feat[0].properties.population}<br>
                        Sanitation: ${feat[0].properties.sanitation}<br>
                        Water: ${feat[0].properties.water}<br>
                        Housing: ${feat[0].properties.housing}<br>
                        Education: ${feat[0].properties.education}<br> 
                        </p>`;// feat.length
            });

            map.on('mouseleave', 'res5-layer', () => {
                map.getCanvas().style.cursor = '';
                popup.remove();
                document.getElementById('pd').innerHTML = '<p>Hover over a hexagon!</p>';
            });


            // Add ruler to mapbox
            // https://docs.mapbox.com/mapbox-gl-js/api/markers/#scalecontrol
            const scale = new mapboxgl.ScaleControl({
                maxWidth: 80,
                unit: 'metric'
            });
            map.addControl(scale);

            const nav = new mapboxgl.NavigationControl({
                visualizePitch: true,
                showCompass: true,
                showZoom: true
            });
            map.addControl(nav, 'top-right');


        });

    </script>

</body>

</html>